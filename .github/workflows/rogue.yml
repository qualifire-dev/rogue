name: Rogue

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-rogue:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install rogue
        run: uv pip install -e . --system
#
#      - name: Run shirtify agent in background
#        uses: JarvusInnovations/background-action@v1
#        env:
#          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#        with:
#          run: uv run examples/tshirt_store_agent --host 0.0.0.0 --port 10001 &
#          wait-on: http-get://localhost:10001/.well-known/agent.json
#          tail: true
#
#      - name: Run rogue
#        uses: ./.github/actions/rogue
#        env:
#          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#        with:
#          evaluated_agent_url: "http://localhost:10001"
#          judge_llm_model: "openai/o4-mini"
#          workdir: "./examples/tshirt_store_agent/.rogue"

      - name: Run rogue
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "üöÄ Starting AI agent..."
          uv run examples/tshirt_store_agent --host 0.0.0.0 --port 10001 &
          AGENT_PID=$!
          echo "Agent started with PID: $AGENT_PID"
          trap 'echo "üõë Stopping agent..."; kill $AGENT_PID' EXIT
          
          echo "‚è≥ Waiting for agent to be ready..."
          curl --retry 10 --retry-delay 5 --retry-connrefused -s --fail http://localhost:10001/.well-known/agent.json
          
          curl --retry 10 --retry-delay 5 --retry-connrefused -s --fail -o /dev/null \
            http://localhost:10001/.well-known/agent.json
          
          echo "üöÄ Running rogue..."
          uv run -m rogue cli \
            --debug \
            --evaluated-agent-url http://localhost:10001 \
            --judge-llm-model openai/o4-mini \
            --workdir './examples/tshirt_store_agent/.rogue'
