name: Rogue

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  rogue-sanity:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Create venv
        run: uv venv

      - name: Install rogue sdk
        run: source .venv/bin/activate && uv pip install -e sdks/python

      - name: Install rogue server
        run: source .venv/bin/activate && uv pip install -e .

      - name: Run rogue
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "üöÄ Starting AI agent..."
          uv run examples/tshirt_store_agent --host 0.0.0.0 --port 10001 &
          AGENT_PID=$!
          echo "Agent started with PID: $AGENT_PID"
          trap 'echo "üõë Stopping agent..."; kill $AGENT_PID' EXIT

          echo "‚è≥ Waiting for agent to be ready..."
          curl --retry 10 --retry-delay 5 --retry-connrefused -s --fail -o /dev/null \
            http://localhost:10001/.well-known/agent.json

          echo "üöÄ Starting rogue server..."
          uv run -m rogue server --host 0.0.0.0 --port 8000 &
          ROGUE_PID=$!
          echo "Rogue server started with PID: $ROGUE_PID"
          trap 'echo "üõë Stopping rogue server..."; kill $ROGUE_PID' EXIT

          echo "‚è≥ Waiting for rogue server to be ready..."
          curl --retry 10 --retry-delay 5 --retry-connrefused -s --fail -o /dev/null \
            http://localhost:8000/api/v1/health
          echo "üöÄ Rogue server ready"
          
          echo "üöÄ Running rogue..."
          uv run -m rogue cli \
            --debug \
            --evaluated-agent-url http://localhost:10001 \
            --judge-llm openai/o4-mini \
            --workdir './examples/tshirt_store_agent/.rogue'
