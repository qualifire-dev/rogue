name: Import Time CI

on:
  pull_request:
  push:

jobs:
  import-time:
    name: Import Time Gate
    runs-on: ubuntu-latest
    env:
      PACKAGE_NAME: rogue
      THRESHOLD_SECONDS: "1.0"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Check import time
        shell: bash
        run: |
          python - << 'PY'
          import importlib, os, sys
          import subprocess, time

          package = os.getenv("PACKAGE_NAME", "rogue")
          threshold = float(os.getenv("THRESHOLD_SECONDS", "1.0"))

          def cold_import_once(pkg: str) -> float:
              code = (
                  "import importlib, time; "
                  f"t=time.perf_counter(); importlib.import_module('{pkg}'); "
                  "print(time.perf_counter()-t)"
              )
              try:
                  out = subprocess.check_output([sys.executable, "-c", code], text=True).strip()
                  return float(out)
              except subprocess.CalledProcessError as e:
                  err = getattr(e, "stderr", None)
                  if err is None:
                      err = "(no stderr captured)"
                  print(f"FAIL: Import subprocess failed with exit code {e.returncode}: {err}", file=sys.stderr)
                  sys.exit(1)
              except ValueError:
                  print(f"FAIL: Could not parse import time from output: {out!r}", file=sys.stderr)
                  sys.exit(1)

          times = [cold_import_once(package) for _ in range(5)]
          best = min(times)
          print(f"Best import time for '{package}': {best:.4f} s (threshold {threshold:.2f} s)")
          if best > threshold:
              print("FAIL: Import time exceeded threshold.", file=sys.stderr)
              sys.exit(1)
          PY
